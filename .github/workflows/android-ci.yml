name: Android CI (Kotlin + Gradle)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      matrix:
        api-level: [21, 29, 34]  # Min, mid, latest
        target: [google_apis]    # Use google_apis for Play Services if needed

    steps:
      # 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Set up JDK 17 (default for AGP 8.3+)
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # 3. Grant execute permission for gradlew
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4. Cache Gradle dependencies (saves ~5-7 mins)
      - name: Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 5. Run lint (Kotlin + Detekt)
      - name: Run Lint & Detekt
        run: ./gradlew lintDebug detekt

      # 6. Run Unit Tests
      - name: Run Unit Tests
        run: ./gradlew testDebugUnitTest --continue

      # 7. Run Instrumented Tests (on Emulator)
      - name: Run Instrumented Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: ${{ matrix.target }}
          arch: x86_64
          profile: pixel_5
          script: ./gradlew connectedDebugAndroidTest

      # 8. Upload Test Reports
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-api${{ matrix.api-level }}
          path: |
            app/build/reports/
            app/build/test-results/

      # 9. Build APK (Release)
      - name: Build Release APK
        run: ./gradlew assembleRelease

      # 10. Upload APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/*.apk

      # 11. (Optional) Sign & Upload to Play Store
      # - name: Sign & Deploy to Play Store (Internal Track)
      #   if: github.ref == 'refs/heads/main'
      #   uses: r0adkll/upload-google-play@v1
      #   with:
      #     serviceAccountJson: ${{ secrets.PLAY_STORE_JSON }}
      #     packageName: com.your.app
      #     releaseFiles: app/build/outputs/bundle/release/app-release.aab
      #     track: internal